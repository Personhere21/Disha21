<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Disha - Bus Tracking</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f5f5f5;
        color: #000;
        -webkit-font-smoothing: antialiased;
        overflow-x: hidden;
      }

      /* Header */
      header {
        background: #fff;
        padding: 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 999; /* FIXED: Increased z-index */
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 600px;
        margin: 0 auto;
      }

      .logo {
        font-size: 24px;
        font-weight: 700;
      }

      .admin-btn {
        background: #000;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }

      /* Bottom Nav */
      nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        display: flex;
        justify-content: space-around;
        padding: 12px 0;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        z-index: 999; /* FIXED: Increased z-index */
      }

      .nav-btn {
        background: none;
        border: none;
        font-size: 24px;
        padding: 8px;
        opacity: 0.5;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .nav-btn.active {
        opacity: 1;
      }

      /* Container */
      .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 16px;
        padding-bottom: 80px;
      }

      /* Tab Content */
      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Map - FIXED: Added pointer-events and z-index */
      #map,
      #route-map {
        height: 300px;
        width: 100%;
        border-radius: 12px;
        margin-bottom: 16px;
        z-index: 1; /* FIXED: Lower z-index than nav */
        position: relative;
      }

      /* Prevent map touch events from interfering */
      .leaflet-container {
        z-index: 1 !important;
      }

      /* Cards */
      .card {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1;
      }

      .card h2 {
        font-size: 18px;
        margin-bottom: 12px;
        font-weight: 700;
      }

      /* Input */
      input,
      select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 12px;
        font-size: 16px;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #000;
      }

      /* Button */
      .btn {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 12px;
        transition: opacity 0.2s;
      }

      .btn:active {
        opacity: 0.7;
      }

      .btn-primary {
        background: #000;
        color: #fff;
      }

      .btn-secondary {
        background: #f0f0f0;
        color: #000;
      }

      .btn-danger {
        background: #ff3b30;
        color: #fff;
      }

      .btn-success {
        background: #34c759;
        color: #fff;
      }

      /* Bus Item */
      .bus-item {
        padding: 12px;
        background: #f9f9f9;
        border-radius: 8px;
        margin-bottom: 8px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
      }

      .bus-item:active {
        transform: scale(0.98);
      }

      .bus-item.active {
        border-color: #000;
        background: #fff;
      }

      .bus-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
      }

      .bus-name {
        font-weight: 600;
      }

      .bus-info {
        font-size: 14px;
        color: #666;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-active {
        background: #e8f5e9;
        color: #2e7d32;
      }

      /* Route Card */
      .route-card {
        padding: 12px;
        background: #f9f9f9;
        border-radius: 8px;
        margin-bottom: 8px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
      }

      .route-card:active {
        transform: scale(0.98);
        border-color: #000;
      }

      /* Seat Grid */
      .seat-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin: 16px 0;
      }

      .seat {
        aspect-ratio: 1;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: transform 0.1s;
      }

      .seat:active {
        transform: scale(0.95);
      }

      .seat.available {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .seat.selected {
        background: #000;
        color: #fff;
      }

      .seat.booked {
        background: #f0f0f0;
        color: #999;
        cursor: not-allowed;
      }

      /* Stats */
      .stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 16px;
      }

      .stat {
        background: #fff;
        padding: 16px;
        border-radius: 12px;
        text-align: center;
      }

      .stat-number {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .stat-label {
        font-size: 14px;
        color: #666;
      }

      /* Modal - FIXED: Proper z-index and positioning */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999; /* FIXED: Highest z-index */
        padding: 16px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; /* FIXED: Smooth scrolling on iOS */
      }

      .modal-content {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        max-width: 500px;
        margin: 40px auto;
        position: relative;
        z-index: 10000; /* FIXED: Above modal background */
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        padding: 0;
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Tracking Status */
      .status-box {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .status-box.active {
        background: #e8f5e9;
        border: 2px solid #4caf50;
      }

      .status-box.inactive {
        background: #fff3e0;
        border: 2px solid #ff9800;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #4caf50;
        animation: pulse 2s infinite;
        flex-shrink: 0;
      }

      .status-dot.inactive {
        background: #ff9800;
        animation: none;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* SOS Button */
      .sos-btn {
        position: fixed;
        bottom: 80px;
        right: 16px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #ff3b30;
        color: #fff;
        border: none;
        font-size: 24px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 998; /* FIXED: Below modals but above content */
        cursor: pointer;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        overflow-x: auto;
      }

      .tab {
        padding: 8px 16px;
        background: #f0f0f0;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        white-space: nowrap;
        cursor: pointer;
      }

      .tab.active {
        background: #000;
        color: #fff;
      }

      /* Suggestions */
      .suggestions {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-top: -8px;
        margin-bottom: 12px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 100;
        position: relative;
      }

      .suggestion-item {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }

      .suggestion-item:active {
        background: #f5f5f5;
      }

      /* Info Box */
      .info-box {
        background: #e3f2fd;
        border: 2px solid #2196f3;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
      }

      .info-box strong {
        display: block;
        margin-bottom: 4px;
      }

      .hidden {
        display: none !important;
      }

      /* FIXED: Prevent body scroll when modal is open */
      body.modal-open {
        overflow: hidden;
      }

      /* Desktop */
      @media (min-width: 768px) {
        #map,
        #route-map {
          height: 400px;
        }
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header>
      <div class="header-content">
        <div class="logo">üöå Disha</div>
        <button class="admin-btn" onclick="openAdmin()">Admin</button>
      </div>
    </header>

    <!-- Main Container -->
    <div class="container">
      <!-- TRACKING TAB -->
      <div id="tracking" class="tab-content active">
        <div id="map"></div>

        <div class="card">
          <h2>üöç Live Buses</h2>
          <div id="bus-list"></div>
        </div>

        <div id="bus-details-card" class="card" style="display: none">
          <h2>üìç Bus Details</h2>
          <div id="bus-details-content"></div>
        </div>
      </div>

      <!-- ROUTES TAB -->
      <div id="routes" class="tab-content">
        <div class="card">
          <h2>üõ£Ô∏è Find Route</h2>
          <label
            style="
              display: block;
              margin-bottom: 4px;
              font-size: 14px;
              font-weight: 600;
            "
            >From</label
          >
          <input id="from-input" type="text" placeholder="e.g., MIT AOE" />
          <div id="from-suggestions" class="suggestions"></div>

          <label
            style="
              display: block;
              margin-bottom: 4px;
              font-size: 14px;
              font-weight: 600;
            "
            >To</label
          >
          <input id="to-input" type="text" placeholder="e.g., TB Petrol" />
          <div id="to-suggestions" class="suggestions"></div>

          <label
            style="
              display: block;
              margin-bottom: 4px;
              font-size: 14px;
              font-weight: 600;
            "
            >Bus Number (Optional)</label
          >
          <input id="bus-input" type="text" placeholder="e.g., 123 or 124" />
          <div id="bus-suggestions" class="suggestions"></div>

          <button class="btn btn-primary" onclick="searchRoute()">
            üîç Find Route
          </button>
        </div>

        <div id="route-results" style="display: none">
          <div id="route-map"></div>

          <div class="card">
            <h2>üìç Suggested Routes</h2>
            <div id="routes-list"></div>
          </div>
        </div>

        <div id="journey-info" class="card" style="display: none">
          <div id="journey-content"></div>
          <button
            id="start-btn"
            class="btn btn-success"
            onclick="startJourney()"
          >
            üöÄ Start Journey
          </button>
          <button
            id="walking-btn"
            class="btn btn-primary"
            style="display: none"
            onclick="completeWalk()"
          >
            üëü Completed Walking
          </button>
        </div>
      </div>

      <!-- BOOKING TAB -->
      <div id="booking" class="tab-content">
        <div class="card">
          <h2>üé´ Book Ticket</h2>
          <input id="book-from" type="text" placeholder="From" />
          <input id="book-to" type="text" placeholder="To" />
          <input type="date" id="date-input" />
          <select id="passenger-type">
            <option value="1">Regular - ‚Çπ100</option>
            <option value="0.5">Child (50% off) - ‚Çπ50</option>
            <option value="0.7">Senior Citizen (30% off) - ‚Çπ70</option>
            <option value="0.9">Women (10% off) - ‚Çπ90</option>
            <option value="0.8">Govt Employee (20% off) - ‚Çπ80</option>
          </select>
        </div>

        <div class="card">
          <h2>ü™ë Select Seats</h2>
          <div
            style="
              background: #000;
              color: #fff;
              text-align: center;
              padding: 8px;
              border-radius: 8px;
              margin-bottom: 12px;
            "
          >
            üöó Driver
          </div>
          <div class="seat-grid" id="seat-grid"></div>

          <div
            style="display: flex; gap: 12px; margin: 12px 0; font-size: 12px"
          >
            <div style="display: flex; align-items: center; gap: 4px">
              <div
                style="
                  width: 20px;
                  height: 20px;
                  background: #e8f5e9;
                  border-radius: 4px;
                "
              ></div>
              <span>Available</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px">
              <div
                style="
                  width: 20px;
                  height: 20px;
                  background: #000;
                  border-radius: 4px;
                "
              ></div>
              <span>Selected</span>
            </div>
            <div style="display: flex; align-items: center; gap: 4px">
              <div
                style="
                  width: 20px;
                  height: 20px;
                  background: #f0f0f0;
                  border-radius: 4px;
                "
              ></div>
              <span>Booked</span>
            </div>
          </div>

          <div
            style="
              padding: 12px;
              background: #f9f9f9;
              border-radius: 8px;
              margin-bottom: 12px;
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
              "
            >
              <span>Selected Seats:</span>
              <strong id="selected-seats">None</strong>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                font-size: 18px;
                font-weight: 700;
              "
            >
              <span>Total Amount:</span>
              <span id="total-price">‚Çπ0</span>
            </div>
          </div>
          <button class="btn btn-success" onclick="confirmBooking()">
            üí≥ Proceed to Payment
          </button>
        </div>
      </div>

      <!-- PROFILE TAB -->
      <div id="profile" class="tab-content">
        <div class="stats">
          <div class="stat">
            <div class="stat-number">18</div>
            <div class="stat-label">Total Trips</div>
          </div>
          <div class="stat">
            <div class="stat-number">2</div>
            <div class="stat-label">Upcoming</div>
          </div>
          <div class="stat">
            <div class="stat-number">180</div>
            <div class="stat-label">Reward Points</div>
          </div>
          <div class="stat">
            <div class="stat-number">‚Çπ450</div>
            <div class="stat-label">Saved</div>
          </div>
        </div>

        <div class="card">
          <h2>üìã Recent Bookings</h2>
          <div class="bus-item">
            <div class="bus-header">
              <span class="bus-name">MIT to Pune Station</span>
              <span class="badge badge-active">Upcoming</span>
            </div>
            <div class="bus-info">Oct 15, 2025 ‚Ä¢ ‚Çπ100 ‚Ä¢ Seat 12</div>
          </div>
          <div class="bus-item">
            <div class="bus-header">
              <span class="bus-name">MIT AOE to TB Petrol</span>
              <span style="color: #999; font-size: 12px">Completed</span>
            </div>
            <div class="bus-info">Oct 10, 2025 ‚Ä¢ ‚Çπ80 ‚Ä¢ Seat 8</div>
          </div>
          <div class="bus-item">
            <div class="bus-header">
              <span class="bus-name">GM Road to Yashada</span>
              <span style="color: #999; font-size: 12px">Completed</span>
            </div>
            <div class="bus-info">Oct 5, 2025 ‚Ä¢ ‚Çπ70 ‚Ä¢ Seat 15</div>
          </div>
        </div>

        <div class="card">
          <h2>üéÅ Loyalty Program</h2>
          <p style="margin-bottom: 8px">
            Progress: <strong>12/20 bookings</strong>
          </p>
          <div
            style="
              height: 8px;
              background: #f0f0f0;
              border-radius: 8px;
              overflow: hidden;
            "
          >
            <div style="width: 60%; height: 100%; background: #000"></div>
          </div>
          <p style="margin-top: 8px; font-size: 14px; color: #666">
            8 more trips for a FREE ride! üéâ
          </p>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <nav>
      <button
        class="nav-btn active"
        onclick="showTab('tracking')"
        data-tab="tracking"
        title="Track Buses"
      >
        üó∫Ô∏è
      </button>
      <button
        class="nav-btn"
        onclick="showTab('routes')"
        data-tab="routes"
        title="Find Routes"
      >
        üõ£Ô∏è
      </button>
      <button
        class="nav-btn"
        onclick="showTab('booking')"
        data-tab="booking"
        title="Book Tickets"
      >
        üé´
      </button>
      <button
        class="nav-btn"
        onclick="showTab('profile')"
        data-tab="profile"
        title="Profile"
      >
        üë§
      </button>
    </nav>

    <!-- SOS Button -->
    <button class="sos-btn" onclick="triggerSOS()" title="Emergency SOS">
      üö®
    </button>

    <!-- Admin Modal -->
    <div id="admin-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>üîê Admin Panel</h2>
          <button class="close-btn" onclick="closeAdmin()">‚úï</button>
        </div>

        <div id="admin-login">
          <input
            type="password"
            id="admin-pass"
            placeholder="Enter Admin Password"
          />
          <button class="btn btn-primary" onclick="login()">Login</button>
          <p
            style="
              text-align: center;
              color: #666;
              font-size: 14px;
              margin-top: 8px;
            "
          >
            Default Password: <strong>admin123</strong>
          </p>
        </div>

        <div id="admin-content" class="hidden">
          <div class="tabs">
            <button class="tab active" onclick="switchAdminTab('control')">
              üìç Control
            </button>
            <button class="tab" onclick="switchAdminTab('add')">
              ‚ûï Add Bus
            </button>
            <button class="tab" onclick="switchAdminTab('manage')">
              üìä Manage
            </button>
          </div>

          <!-- Control Tab -->
          <div id="control" class="tab-content active">
            <div id="status-banner" class="status-box inactive">
              <div class="status-dot inactive"></div>
              <div style="flex: 1">
                <div style="font-weight: 600" id="status-text">
                  Tracking: Inactive
                </div>
                <div id="coords" style="font-size: 12px; color: #666">
                  Click Start to begin tracking
                </div>
              </div>
            </div>

            <label
              style="
                display: block;
                margin-bottom: 4px;
                font-size: 14px;
                font-weight: 600;
              "
              >Select Bus to Track:</label
            >
            <select id="bus-select" style="margin-bottom: 12px">
              <option value="123">Bus 123 - MIT AOE to TB Petrol</option>
              <option value="124">Bus 124 - GM Road to Yashada</option>
            </select>

            <button class="btn btn-success" onclick="startTrack()">
              üìç Start Tracking This Device
            </button>
            <button class="btn btn-danger" onclick="stopTrack()">
              ‚èπÔ∏è Stop Tracking
            </button>

            <div class="info-box" style="margin-top: 12px">
              <strong>‚ÑπÔ∏è How it works:</strong>
              <p style="font-size: 14px; margin-top: 4px">
                Your phone's GPS will update the selected bus location in
                real-time. Users will see the bus moving on the map.
              </p>
            </div>
          </div>

          <!-- Add Bus Tab -->
          <div id="add" class="tab-content">
            <label
              style="
                display: block;
                margin-bottom: 4px;
                font-size: 14px;
                font-weight: 600;
              "
              >Bus Name:</label
            >
            <input id="new-name" type="text" placeholder="e.g., Bus 125" />

            <label
              style="
                display: block;
                margin-bottom: 4px;
                font-size: 14px;
                font-weight: 600;
              "
              >Route:</label
            >
            <input
              id="new-route"
              type="text"
              placeholder="e.g., Airport to City Center"
            />

            <label
              style="
                display: block;
                margin-bottom: 4px;
                font-size: 14px;
                font-weight: 600;
              "
              >Driver Name:</label
            >
            <input id="new-driver" type="text" placeholder="Driver Name" />

            <label
              style="
                display: block;
                margin-bottom: 4px;
                font-size: 14px;
                font-weight: 600;
              "
              >Phone Number:</label
            >
            <input id="new-phone" type="tel" placeholder="+91 98765 43210" />

            <label
              style="
                display: block;
                margin-bottom: 4px;
                font-size: 14px;
                font-weight: 600;
              "
              >Total Seats:</label
            >
            <input
              id="new-seats"
              type="number"
              placeholder="40"
              value="40"
              min="1"
              max="60"
            />

            <button class="btn btn-success" onclick="addBus()">
              ‚úÖ Add New Bus
            </button>
          </div>

          <!-- Manage Tab -->
          <div id="manage" class="tab-content">
            <h3 style="margin-bottom: 12px; font-size: 16px">
              All Registered Buses
            </h3>
            <div id="admin-bus-list"></div>
            <button
              class="btn btn-secondary"
              onclick="refreshAdmin()"
              style="margin-top: 8px"
            >
              üîÑ Refresh List
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
        update,
      } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBR4RefmKkAh0jUurXobTWQRSuTs1qDd5I",
        authDomain: "disha-20351.firebaseapp.com",
        databaseURL:
          "https://disha-20351-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "disha-20351",
        storageBucket: "disha-20351.firebasestorage.app",
        messagingSenderId: "236707569701",
        appId: "1:236707569701:web:0ad076062cdfa5f7291fcc",
        measurementId: "G-RS0M1LLNRG",
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      window.firebaseDb = database;
      window.firebaseRef = ref;
      window.firebaseSet = set;
      window.firebaseOnValue = onValue;
      window.firebaseUpdate = update;

      window.initFirebase = function () {
        ["123", "124"].forEach((id) => {
          const busRef = ref(database, "buses/" + id);
          onValue(busRef, (snapshot) => {
            const data = snapshot.val();
            if (data && data.position && window.busData && window.busData[id]) {
              window.busData[id].position = data.position;
              window.busData[id].lastUpdate = data.lastUpdate;
              if (window.updateMarkers) window.updateMarkers();
              console.log(`üîÑ Bus ${id} position updated from Firebase`);
            }
          });
        });
        console.log("‚úÖ Firebase real-time listeners initialized");
      };
    </script>

    <script>
      // ==================== GLOBAL VARIABLES ====================
      let map, routeMap;
      let markers = {};
      let routeMarkers = {};
      let watchId = null;
      let selectedSeats = [];
      let currentRoute = null;
      let stopIndex = 0;
      let isWalking = false;
      let journeyInterval = null;
      let selectedBusId = null;

      // ==================== BUS DATA ====================
      const busData = {
        123: {
          id: "123",
          name: "Bus 123",
          route: "MIT AOE to TB Petrol",
          driver: "Rajesh Kumar",
          phone: "+91 98765 43210",
          position: { lat: 18.674892, lng: 73.892413 },
          speed: 45,
          seats: 12,
          total: 40,
          status: "active",
        },
        124: {
          id: "124",
          name: "Bus 124",
          route: "GM Road to Yashada Supreme",
          driver: "Suresh Patil",
          phone: "+91 98765 43211",
          position: { lat: 18.675914, lng: 73.879192 },
          speed: 38,
          seats: 5,
          total: 40,
          status: "active",
        },
      };
      window.busData = busData;

      // ==================== ROUTE DATA ====================
      const routeStops = {
        123: {
          name: "Route 123: MIT AOE to TB Petrol",
          stops: [
            { name: "MIT AOE", lat: 18.674892, lng: 73.892413 },
            { name: "MIT", lat: 18.671983, lng: 73.890473 },
            { name: "MIT ACSC", lat: 18.672569, lng: 73.889377 },
            { name: "HPC Petrol", lat: 18.673288, lng: 73.887728 },
            { name: "Hospital", lat: 18.67436, lng: 73.884904 },
            { name: "TB Petrol", lat: 18.674852, lng: 73.88306 },
          ],
          distance: "3.5 km",
          time: "15 min",
        },
        124: {
          name: "Route 124: GM Road to Yashada Supreme",
          stops: [
            { name: "GM Road", lat: 18.675914, lng: 73.879192 },
            { name: "Hari Om Clinic", lat: 18.674666, lng: 73.878783 },
            { name: "Gems School", lat: 18.673632, lng: 73.878347 },
            { name: "Yashada Supreme", lat: 18.673096, lng: 73.878101 },
          ],
          distance: "2.8 km",
          time: "12 min",
        },
      };

      const walkingSegment = {
        from: { name: "TB Petrol", lat: 18.674852, lng: 73.88306 },
        to: { name: "GM Road", lat: 18.675914, lng: 73.879192 },
        distance: "0.5 km",
        time: "6 min",
      };

      const allStops = [...routeStops[123].stops, ...routeStops[124].stops].map(
        (s) => s.name
      );

      // ==================== MAP INITIALIZATION ====================
      function initMap() {
        try {
          map = L.map("map", {
            zoomControl: true,
            scrollWheelZoom: true,
          }).setView([18.674892, 73.892413], 13);

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "¬© OpenStreetMap contributors",
          }).addTo(map);

          // Draw route lines
          const coords123 = routeStops[123].stops.map((s) => [s.lat, s.lng]);
          L.polyline(coords123, {
            color: "#2196f3",
            weight: 3,
            opacity: 0.5,
          }).addTo(map);

          const coords124 = routeStops[124].stops.map((s) => [s.lat, s.lng]);
          L.polyline(coords124, {
            color: "#4caf50",
            weight: 3,
            opacity: 0.5,
          }).addTo(map);

          updateMarkers();
          console.log("‚úÖ Main map initialized");
        } catch (e) {
          console.error("Map init error:", e);
        }
      }

      // ==================== UPDATE BUS MARKERS ====================
      function updateMarkers() {
        Object.values(busData).forEach((bus) => {
          if (markers[bus.id]) {
            markers[bus.id].setLatLng([bus.position.lat, bus.position.lng]);
          } else {
            const icon = L.divIcon({
              html: `<div style="background: #000; color: #fff; padding: 6px 10px; border-radius: 8px; font-weight: bold; font-size: 12px; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">üöå ${bus.name}</div>`,
              className: "",
              iconSize: [80, 30],
              iconAnchor: [40, 15],
            });

            markers[bus.id] = L.marker([bus.position.lat, bus.position.lng], {
              icon,
            }).addTo(map).bindPopup(`
                            <div style="text-align: center;">
                                <strong style="font-size: 16px;">${bus.name}</strong><br>
                                <span style="color: #666;">${bus.route}</span><br>
                                <strong style="color: #2196f3;">Speed: ${bus.speed} km/h</strong><br>
                                <span style="color: #4caf50;">Available: ${bus.seats} seats</span>
                            </div>
                        `);
          }
        });
      }
      window.updateMarkers = updateMarkers;

      // ==================== RENDER BUS LIST ====================
      function renderBuses() {
        const list = document.getElementById("bus-list");
        list.innerHTML = "";

        Object.values(busData).forEach((bus) => {
          const div = document.createElement("div");
          div.className =
            "bus-item" + (selectedBusId === bus.id ? " active" : "");
          div.onclick = () => selectBus(bus.id);
          div.innerHTML = `
                    <div class="bus-header">
                        <span class="bus-name">${bus.name}</span>
                        <span class="badge badge-active">${bus.status}</span>
                    </div>
                    <div class="bus-info">${bus.route}</div>
                    <div class="bus-info">${bus.seats} seats available ‚Ä¢ ${bus.speed} km/h</div>
                `;
          list.appendChild(div);
        });
      }

      // ==================== SELECT BUS ====================
      function selectBus(id) {
        selectedBusId = id;
        renderBuses();

        const bus = busData[id];
        document.getElementById("bus-details-card").style.display = "block";
        document.getElementById("bus-details-content").innerHTML = `
                <div style="margin-bottom: 12px;">
                    <p style="margin-bottom: 8px;"><strong>Route:</strong> ${bus.route}</p>
                    <p style="margin-bottom: 8px;"><strong>Driver:</strong> ${bus.driver}</p>
                    <p style="margin-bottom: 8px;"><strong>Contact:</strong> ${bus.phone}</p>
                    <p style="margin-bottom: 8px;"><strong>Current Speed:</strong> ${bus.speed} km/h</p>
                    <p style="margin-bottom: 8px;"><strong>Available Seats:</strong> ${bus.seats}/${bus.total}</p>
                </div>
                <button class="btn btn-primary" onclick="locateBus('${id}')">üìç Locate on Map</button>
                <button class="btn btn-success" onclick="quickBook('${id}')">üé´ Quick Book</button>
            `;

        map.setView([bus.position.lat, bus.position.lng], 15);
        markers[id].openPopup();
      }

      function locateBus(id) {
        const bus = busData[id];
        map.setView([bus.position.lat, bus.position.lng], 16);
        markers[id].openPopup();
      }

      function quickBook(id) {
        showTab("booking");
      }

      // ==================== AUTOCOMPLETE ====================
      function setupAuto(inputId, sugId, items) {
        const input = document.getElementById(inputId);
        const sug = document.getElementById(sugId);

        input.addEventListener("input", () => {
          const val = input.value.toLowerCase().trim();
          sug.innerHTML = "";

          if (val) {
            const matches = items.filter((i) => i.toLowerCase().includes(val));
            if (matches.length) {
              sug.style.display = "block";
              matches.slice(0, 5).forEach((m) => {
                const div = document.createElement("div");
                div.className = "suggestion-item";
                div.textContent = m;
                div.onclick = () => {
                  input.value = m;
                  sug.style.display = "none";
                };
                sug.appendChild(div);
              });
            } else {
              sug.style.display = "none";
            }
          } else {
            sug.style.display = "none";
          }
        });

        // Close on outside click
        document.addEventListener("click", (e) => {
          if (!input.contains(e.target) && !sug.contains(e.target)) {
            sug.style.display = "none";
          }
        });
      }

      // ==================== SEARCH ROUTE ====================
      function searchRoute() {
        const from = document.getElementById("from-input").value.trim();
        const to = document.getElementById("to-input").value.trim();
        const busNum = document.getElementById("bus-input").value.trim();

        if (!from || !to) {
          alert("‚ùå Please enter both From and To locations");
          return;
        }

        const found = [];
        const stops123 = routeStops[123].stops.map((s) => s.name);
        const stops124 = routeStops[124].stops.map((s) => s.name);

        const f1 = stops123.indexOf(from);
        const t1 = stops123.indexOf(to);
        const f2 = stops124.indexOf(from);
        const t2 = stops124.indexOf(to);

        // Check specific bus number
        if (busNum === "123" || busNum === "124") {
          const stops = routeStops[busNum].stops.map((s) => s.name);
          const fIdx = stops.indexOf(from);
          const tIdx = stops.indexOf(to);

          if (fIdx !== -1 && tIdx !== -1 && fIdx < tIdx) {
            found.push({
              name: `${routeStops[busNum].name}: ${from} to ${to}`,
              stops: routeStops[busNum].stops.slice(fIdx, tIdx + 1),
              bus: busNum,
              dist: routeStops[busNum].distance,
              time: routeStops[busNum].time,
              routeId: busNum,
            });
          }
        } else {
          // Check route 123
          if (f1 !== -1 && t1 !== -1 && f1 < t1) {
            found.push({
              name: `Bus 123: ${from} to ${to}`,
              stops: routeStops[123].stops.slice(f1, t1 + 1),
              bus: "123",
              dist: `${((t1 - f1) * 0.6).toFixed(1)} km`,
              time: `${Math.round((t1 - f1) * 2.5)} min`,
              routeId: "123",
            });
          }

          // Check route 124
          if (f2 !== -1 && t2 !== -1 && f2 < t2) {
            found.push({
              name: `Bus 124: ${from} to ${to}`,
              stops: routeStops[124].stops.slice(f2, t2 + 1),
              bus: "124",
              dist: `${((t2 - f2) * 0.7).toFixed(1)} km`,
              time: `${Math.round((t2 - f2) * 3)} min`,
              routeId: "124",
            });
          }

          // Multi-route with walking
          if (f1 !== -1 && t2 !== -1) {
            found.push({
              name: `${from} to ${to} (with walking)`,
              stops: [
                ...routeStops[123].stops.slice(f1),
                ...routeStops[124].stops.slice(0, t2 + 1),
              ],
              bus: "123+124",
              dist: "4.0 km",
              time: "21 min",
              walking: walkingSegment,
              routeId: "123",
            });
          }
        }

        if (found.length === 0) {
          alert("‚ùå No route found between these locations");
          return;
        }

        // Show results
        document.getElementById("route-results").style.display = "block";
        const list = document.getElementById("routes-list");
        list.innerHTML = "";

        found.forEach((r) => {
          const div = document.createElement("div");
          div.className = "route-card";
          div.onclick = () => showRoute(r);
          div.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 4px; color: #000;">${
                      r.name
                    }</div>
                    <div style="font-size: 14px; color: #666;">
                        üìè ${r.dist} ‚Ä¢ ‚è±Ô∏è ${r.time}
                        ${r.walking ? " ‚Ä¢ üö∂ Walking required" : ""}
                    </div>
                `;
          list.appendChild(div);
        });

        // Initialize route map
        if (!routeMap) {
          setTimeout(() => {
            routeMap = L.map("route-map").setView([18.674892, 73.892413], 13);
            L.tileLayer(
              "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
            ).addTo(routeMap);
            console.log("‚úÖ Route map initialized");
          }, 100);
        }
      }

      // ==================== SHOW ROUTE ====================
      function showRoute(route) {
        currentRoute = route;
        stopIndex = 0;
        isWalking = false;

        // Clear old markers
        Object.values(routeMarkers).forEach((m) => {
          try {
            m.remove();
          } catch (e) {}
        });
        routeMarkers = {};

        const start = route.stops[0];
        const end = route.stops[route.stops.length - 1];

        // Add markers
        const startIcon = L.divIcon({
          html: '<div style="background: #4caf50; width: 20px; height: 20px; border-radius: 50%; border: 3px solid #fff;"></div>',
          className: "",
          iconSize: [20, 20],
          iconAnchor: [10, 10],
        });

        const endIcon = L.divIcon({
          html: '<div style="background: #f44336; width: 20px; height: 20px; border-radius: 50%; border: 3px solid #fff;"></div>',
          className: "",
          iconSize: [20, 20],
          iconAnchor: [10, 10],
        });

        const busIcon = L.divIcon({
          html: '<div style="background: #2196f3; color: #fff; padding: 6px; border-radius: 8px; font-weight: bold; border: 2px solid #fff;">üöå</div>',
          className: "",
          iconSize: [40, 30],
          iconAnchor: [20, 15],
        });

        routeMarkers.start = L.marker([start.lat, start.lng], {
          icon: startIcon,
        })
          .addTo(routeMap)
          .bindPopup("üü¢ Start: " + start.name);
        routeMarkers.end = L.marker([end.lat, end.lng], { icon: endIcon })
          .addTo(routeMap)
          .bindPopup("üî¥ End: " + end.name);
        routeMarkers.bus = L.marker([start.lat, start.lng], {
          icon: busIcon,
        }).addTo(routeMap);

        // Draw route line
        const coords = route.stops.map((s) => [s.lat, s.lng]);
        L.polyline(coords, { color: "#2196f3", weight: 4 }).addTo(routeMap);

        // Draw walking path if exists
        if (route.walking) {
          const walkCoords = [
            [route.walking.from.lat, route.walking.from.lng],
            [route.walking.to.lat, route.walking.to.lng],
          ];
          L.polyline(walkCoords, {
            color: "#ff9800",
            dashArray: "10, 10",
            weight: 3,
          }).addTo(routeMap);

          const walkIcon = L.divIcon({
            html: '<div style="background: #ff9800; width: 20px; height: 20px; border-radius: 50%; border: 3px solid #fff;"></div>',
            className: "",
            iconSize: [20, 20],
            iconAnchor: [10, 10],
          });
          routeMarkers.walk = L.marker(
            [route.walking.from.lat, route.walking.from.lng],
            { icon: walkIcon }
          )
            .addTo(routeMap)
            .bindPopup("üö∂ Walk from here");
        }

        routeMap.fitBounds(coords);

        // Show journey info
        document.getElementById("journey-info").style.display = "block";
        document.getElementById("journey-content").innerHTML = `
                <div class="info-box">
                    <strong style="font-size: 16px;">${route.name}</strong>
                    <p style="margin-top: 8px;">üöå Board Bus ${
                      route.bus.split("+")[0]
                    } at <strong>${start.name}</strong></p>
                    <p>üìè Distance: ${route.dist} ‚Ä¢ ‚è±Ô∏è Time: ${route.time}</p>
                    ${
                      route.walking
                        ? `<p style="color: #ff9800; margin-top: 8px;">‚ö†Ô∏è Walking required: ${route.walking.distance} (${route.walking.time})</p>`
                        : ""
                    }
                </div>
            `;

        document.getElementById("start-btn").style.display = "block";
        document.getElementById("start-btn").textContent = "üöÄ Start Journey";
        document.getElementById("start-btn").disabled = false;
        document.getElementById("walking-btn").style.display = "none";

        // Scroll to journey info
        document
          .getElementById("journey-info")
          .scrollIntoView({ behavior: "smooth", block: "nearest" });
      }

      // ==================== START JOURNEY ====================
      function startJourney() {
        if (!currentRoute) return;

        document.getElementById("start-btn").textContent =
          "üöå Journey in Progress...";
        document.getElementById("start-btn").disabled = true;

        journeyInterval = setInterval(() => {
          if (!isWalking && stopIndex < currentRoute.stops.length - 1) {
            stopIndex++;
            const stop = currentRoute.stops[stopIndex];
            routeMarkers.bus.setLatLng([stop.lat, stop.lng]);
            routeMarkers.bus.bindPopup(`Now at: ${stop.name}`).openPopup();

            // Check if need to walk
            if (
              currentRoute.walking &&
              stop.name === currentRoute.walking.from.name
            ) {
              clearInterval(journeyInterval);
              isWalking = true;

              document.getElementById("journey-content").innerHTML = `
                            <div class="info-box" style="background: #fff3e0; border-color: #ff9800;">
                                <strong style="font-size: 16px;">üö∂ Walking Required</strong>
                                <p style="margin-top: 8px;">Walk ${currentRoute.walking.distance} from <strong>${currentRoute.walking.from.name}</strong> to <strong>${currentRoute.walking.to.name}</strong></p>
                                <p>‚è±Ô∏è Estimated time: ${currentRoute.walking.time}</p>
                            </div>
                        `;

              document.getElementById("start-btn").style.display = "none";
              document.getElementById("walking-btn").style.display = "block";
            }
          } else if (!isWalking && stopIndex >= currentRoute.stops.length - 1) {
            clearInterval(journeyInterval);
            document.getElementById("start-btn").innerHTML =
              "üéâ Journey Complete!";
            document.getElementById("start-btn").style.display = "block";
            document.getElementById("start-btn").disabled = true;

            document.getElementById("journey-content").innerHTML = `
                        <div class="info-box" style="background: #e8f5e9; border-color: #4caf50;">
                            <strong style="font-size: 16px;">üéâ Journey Completed!</strong>
                            <p style="margin-top: 8px;">You have arrived at <strong>${
                              currentRoute.stops[currentRoute.stops.length - 1]
                                .name
                            }</strong></p>
                        </div>
                    `;
          }
        }, 3000);
      }

      function completeWalk() {
        if (!currentRoute || !currentRoute.walking) return;

        isWalking = false;
        routeMarkers.bus.setLatLng([
          currentRoute.walking.to.lat,
          currentRoute.walking.to.lng,
        ]);

        document.getElementById("journey-content").innerHTML = `
                <div class="info-box">
                    <strong style="font-size: 16px;">üöå Board Bus ${
                      currentRoute.bus.split("+")[1]
                    }</strong>
                    <p style="margin-top: 8px;">At <strong>${
                      currentRoute.walking.to.name
                    }</strong></p>
                    <p>Continuing journey to destination...</p>
                </div>
            `;

        document.getElementById("walking-btn").style.display = "none";
        document.getElementById("start-btn").style.display = "block";
        document.getElementById("start-btn").textContent =
          "üöÄ Continue Journey";
        document.getElementById("start-btn").disabled = false;

        stopIndex =
          currentRoute.stops.findIndex(
            (s) => s.name === currentRoute.walking.to.name
          ) - 1;

        document.getElementById("start-btn").onclick = startJourney;
      }

      // ==================== SEATS ====================
      function initSeats() {
        const grid = document.getElementById("seat-grid");
        grid.innerHTML = "";
        const booked = [2, 5, 7, 12, 15, 18, 23, 27, 31, 34, 38];

        for (let i = 1; i <= 40; i++) {
          const seat = document.createElement("div");
          seat.className =
            "seat " + (booked.includes(i) ? "booked" : "available");
          seat.textContent = i;

          if (!booked.includes(i)) {
            seat.onclick = () => toggleSeat(i, seat);
          }

          grid.appendChild(seat);
        }
      }

      function toggleSeat(num, el) {
        if (selectedSeats.includes(num)) {
          selectedSeats = selectedSeats.filter((s) => s !== num);
          el.className = "seat available";
        } else {
          if (selectedSeats.length >= 4) {
            alert("‚ùå Maximum 4 seats can be selected at once");
            return;
          }
          selectedSeats.push(num);
          el.className = "seat selected";
        }
        updatePrice();
      }

      function updatePrice() {
        document.getElementById("selected-seats").textContent =
          selectedSeats.length
            ? selectedSeats.sort((a, b) => a - b).join(", ")
            : "None";
        const type = parseFloat(
          document.getElementById("passenger-type").value
        );
        const total = selectedSeats.length * 100 * type;
        document.getElementById("total-price").textContent =
          "‚Çπ" + Math.round(total);
      }

      function confirmBooking() {
        if (selectedSeats.length === 0) {
          alert("‚ùå Please select at least one seat");
          return;
        }

        const from = document.getElementById("book-from").value;
        const to = document.getElementById("book-to").value;
        const date = document.getElementById("date-input").value;

        if (!from || !to || !date) {
          alert("‚ùå Please fill From, To and Date fields");
          return;
        }

        const total = document.getElementById("total-price").textContent;
        const seats = selectedSeats.sort((a, b) => a - b).join(", ");

        alert(
          `‚úÖ Booking Confirmed!\n\nüé´ From: ${from}\nüé´ To: ${to}\nüìÖ Date: ${date}\nü™ë Seats: ${seats}\nüí∞ Total: ${total}\n\nüì± Confirmation SMS sent!\nüí≥ Proceed to payment gateway...`
        );

        selectedSeats = [];
        initSeats();
        updatePrice();
      }

      // ==================== ADMIN FUNCTIONS ====================
      function openAdmin() {
        document.getElementById("admin-modal").style.display = "block";
        document.body.classList.add("modal-open"); // FIXED: Prevent body scroll
      }

      function closeAdmin() {
        document.getElementById("admin-modal").style.display = "none";
        document.body.classList.remove("modal-open"); // FIXED: Re-enable body scroll
      }

      function login() {
        const pass = document.getElementById("admin-pass").value;
        if (pass === "admin123") {
          document.getElementById("admin-login").classList.add("hidden");
          document.getElementById("admin-content").classList.remove("hidden");
          renderAdminBuses();
        } else {
          alert("‚ùå Incorrect password! Try: admin123");
        }
      }

      function switchAdminTab(tabName) {
        document
          .querySelectorAll("#admin-content .tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll("#admin-content .tab-content")
          .forEach((c) => c.classList.remove("active"));
        event.target.classList.add("active");
        document.getElementById(tabName).classList.add("active");
      }

      // ==================== GPS TRACKING ====================
      function startTrack() {
        if (!navigator.geolocation) {
          alert("‚ùå GPS not supported on this device");
          return;
        }

        const id = document.getElementById("bus-select").value;
        const statusBanner = document.getElementById("status-banner");
        const statusText = document.getElementById("status-text");
        const coords = document.getElementById("coords");

        watchId = navigator.geolocation.watchPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            busData[id].position = { lat, lng };

            if (window.firebaseDb) {
              const ref = window.firebaseRef(window.firebaseDb, "buses/" + id);
              window
                .firebaseUpdate(ref, {
                  position: { lat, lng },
                  lastUpdate: new Date().toISOString(),
                  speed: busData[id].speed,
                })
                .then(() => {
                  console.log(`‚úÖ Firebase updated: Bus ${id}`);
                })
                .catch((err) => {
                  console.error("Firebase error:", err);
                });
            }

            updateMarkers();

            statusBanner.className = "status-box active";
            statusBanner.querySelector(".status-dot").className = "status-dot";
            statusText.textContent = "Tracking: Active ‚úÖ";
            coords.textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(
              6
            )}`;
          },
          (err) => {
            console.error("GPS Error:", err);
            alert(`‚ùå GPS Error: ${err.message}`);
          },
          {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 5000,
          }
        );

        alert(
          `‚úÖ Tracking started!\nYour phone is now Bus ${id}\n\nLocation will update every few seconds.`
        );
      }

      function stopTrack() {
        if (watchId) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;

          const statusBanner = document.getElementById("status-banner");
          const statusText = document.getElementById("status-text");

          statusBanner.className = "status-box inactive";
          statusBanner.querySelector(".status-dot").className =
            "status-dot inactive";
          statusText.textContent = "Tracking: Stopped";
          document.getElementById("coords").textContent = "Tracking stopped";

          alert("üìç Tracking stopped successfully");
        } else {
          alert("‚ö†Ô∏è Tracking is not active");
        }
      }

      // ==================== ADD BUS ====================
      function addBus() {
        const name = document.getElementById("new-name").value.trim();
        const route = document.getElementById("new-route").value.trim();
        const driver = document.getElementById("new-driver").value.trim();
        const phone = document.getElementById("new-phone").value.trim();
        const seats = parseInt(document.getElementById("new-seats").value);

        if (!name || !route) {
          alert("‚ùå Please fill Bus Name and Route");
          return;
        }

        const id = "bus" + (Object.keys(busData).length + 1);
        busData[id] = {
          id,
          name,
          route,
          driver: driver || "Not assigned",
          phone: phone || "Not provided",
          position: { lat: 18.674892, lng: 73.892413 },
          speed: 0,
          seats: seats || 40,
          total: seats || 40,
          status: "inactive",
        };

        renderBuses();
        renderAdminBuses();

        document.getElementById("new-name").value = "";
        document.getElementById("new-route").value = "";
        document.getElementById("new-driver").value = "";
        document.getElementById("new-phone").value = "";
        document.getElementById("new-seats").value = "40";

        alert(`‚úÖ Bus added successfully!\n\nüöå ${name}\nüõ£Ô∏è ${route}`);
      }

      function renderAdminBuses() {
        const list = document.getElementById("admin-bus-list");
        list.innerHTML = "";

        Object.values(busData).forEach((bus) => {
          const div = document.createElement("div");
          div.className = "bus-item";
          div.innerHTML = `
                    <div class="bus-header">
                        <strong>${bus.name}</strong>
                        <span class="badge ${
                          bus.status === "active" ? "badge-active" : ""
                        }" style="${
            bus.status !== "active" ? "background: #f0f0f0; color: #666;" : ""
          }">${bus.status}</span>
                    </div>
                    <div style="font-size: 14px; color: #666; margin-top: 4px;">${
                      bus.route
                    }</div>
                    <div style="font-size: 12px; color: #999; margin-top: 4px;">Driver: ${
                      bus.driver
                    } | ${bus.seats}/${bus.total} seats</div>
                `;
          list.appendChild(div);
        });
      }

      function refreshAdmin() {
        renderAdminBuses();
        alert("üîÑ Admin data refreshed!");
      }

      // ==================== TAB NAVIGATION ====================
      function showTab(tab) {
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".nav-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(tab).classList.add("active");
        document.querySelector(`[data-tab="${tab}"]`).classList.add("active");

        // Refresh map when switching tabs
        if (tab === "tracking" && map) {
          setTimeout(() => map.invalidateSize(), 100);
        }
        if (tab === "routes" && routeMap) {
          setTimeout(() => routeMap.invalidateSize(), 100);
        }
      }

      // ==================== SOS ====================
      function triggerSOS() {
        if (
          confirm(
            "üö® Are you sure you want to trigger Emergency SOS?\n\nThis will alert:\n‚Ä¢ Police (100)\n‚Ä¢ Ambulance (108)\n‚Ä¢ Fire (101)\n‚Ä¢ Your emergency contacts"
          )
        ) {
          alert(
            "üö® EMERGENCY ALERT SENT!\n\n‚úÖ Police notified (100)\n‚úÖ Ambulance dispatched (108)\n‚úÖ Bus driver alerted\n‚úÖ Emergency contacts notified\n‚úÖ Live location shared\n\nüöÅ Help is on the way!\n\nStay calm and stay on the line."
          );
        }
      }

      // ==================== INITIALIZATION ====================
      window.onload = function () {
        console.log("üöÄ Disha Bus Tracking System Starting...");

        initMap();
        renderBuses();
        initSeats();

        document.getElementById("date-input").valueAsDate = new Date();

        setupAuto("from-input", "from-suggestions", allStops);
        setupAuto("to-input", "to-suggestions", allStops);
        setupAuto("bus-input", "bus-suggestions", ["123", "124"]);

        document
          .getElementById("passenger-type")
          .addEventListener("change", updatePrice);

        if (window.initFirebase) {
          setTimeout(() => {
            try {
              window.initFirebase();
              console.log("üî• Firebase initialized");
            } catch (e) {
              console.warn("Firebase init delayed:", e);
            }
          }, 1000);
        }

        console.log("‚úÖ Disha initialized successfully!");
      };
    </script>
  </body>
</html>
